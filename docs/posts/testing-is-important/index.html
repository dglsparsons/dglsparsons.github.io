<!DOCTYPE html><html domain=dgls.dev ga-id=UA-177820617-1 lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="/img/favicon/favicon.ico?hash=ba55cd0070" rel=icon><meta content=#f9c412 name=theme-color><title>Testing is important: three ways to easily improve test quality</title><meta content="dgls | dev" property=og:site_name><meta content=https://dgls.dev property=og:url><meta content="Testing is important: three ways to easily improve test quality" property=og:title><meta content=website property=og:type><meta content="Testing is important: three ways to easily improve test quality" property=twitter:title><meta content="It’s no secret that testing is important. We rely on tests to describe intended behaviour, catch any subtle bugs and prevent regressions in our code. But why are tests always such a pain to write well?" name=description><meta content="It’s no secret that testing is important. We rely on tests to describe intended behaviour, catch any subtle bugs and prevent regressions in our code. But why are tests always such a pain to write well?" property=og:description><meta content="It’s no secret that testing is important. We rely on tests to describe intended behaviour, catch any subtle bugs and prevent regressions in our code. But why are tests always such a pain to write well?" property=twitter:description><meta content=summary_large_image name=twitter:card><meta content=@dglsparsons name=twitter:site><meta content=@dglsparsons name=twitter:creator><meta content=https://dgls.dev/img/remote/dark_code.jpg property=twitter:image><meta content=https://dgls.dev/img/remote/Z1Spsoh.jpg property=og:image><link href=https://dgls.dev/posts/testing-is-important/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate title="dgls | blog" type=application/atom+xml><link href=/ rel=preconnect crossorigin=""><script src="/js/min.js?hash=17b5d2d281" async defer></script><script src="/js/cached.js?hash=4628d5e26f" async defer></script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary: #5DFDCB;--primary-dark: #02DE99}.hero,body{display:flex;flex-direction:column}body{min-height:100vh}body main{flex-grow:1}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px}share-widget div{width:30px;height:30px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center}.apple share-widget div{background-image:url(/img/share-apple.svg)}body,share-widget button{margin:0}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark)}aside{font-style:italic}#nav{z-index:2;position:relative}#reading-progress{z-index:1;background-color:var(--primary);width:100vw;position:absolute;left:0;top:0;bottom:0;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:100;src:url(/fonts/Inter-Thin.woff2) format("woff2"),url(/fonts/Inter-Thin.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:100;src:url(/fonts/Inter-ThinItalic.woff2) format("woff2"),url(/fonts/Inter-ThinItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:200;src:url(/fonts/Inter-ExtraLight.woff2) format("woff2"),url(/fonts/Inter-ExtraLight.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:200;src:url(/fonts/Inter-ExtraLightItalic.woff2) format("woff2"),url(/fonts/Inter-ExtraLightItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:300;src:url(/fonts/Inter-Light.woff2) format("woff2"),url(/fonts/Inter-Light.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:300;src:url(/fonts/Inter-LightItalic.woff2) format("woff2"),url(/fonts/Inter-LightItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:400;src:url(/fonts/Inter-Regular.woff2) format("woff2"),url(/fonts/Inter-Regular.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:400;src:url(/fonts/Inter-Italic.woff2) format("woff2"),url(/fonts/Inter-Italic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:500;src:url(/fonts/Inter-Medium.woff2) format("woff2"),url(/fonts/Inter-Medium.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:500;src:url(/fonts/Inter-MediumItalic.woff2) format("woff2"),url(/fonts/Inter-MediumItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:600;src:url(/fonts/Inter-SemiBold.woff2) format("woff2"),url(/fonts/Inter-SemiBold.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:600;src:url(/fonts/Inter-SemiBoldItalic.woff2) format("woff2"),url(/fonts/Inter-SemiBoldItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:700;src:url(/fonts/Inter-Bold.woff2) format("woff2"),url(/fonts/Inter-Bold.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:700;src:url(/fonts/Inter-BoldItalic.woff2) format("woff2"),url(/fonts/Inter-BoldItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:800;src:url(/fonts/Inter-ExtraBold.woff2) format("woff2"),url(/fonts/Inter-ExtraBold.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:800;src:url(/fonts/Inter-ExtraBoldItalic.woff2) format("woff2"),url(/fonts/Inter-ExtraBoldItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:900;src:url(/fonts/Inter-Black.woff2) format("woff2"),url(/fonts/Inter-Black.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:900;src:url(/fonts/Inter-BlackItalic.woff2) format("woff2"),url(/fonts/Inter-BlackItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI var alt';font-weight:100 900;font-style:normal;font-named-instance:'Regular';src:url(/fonts/Inter-roman.var.woff2) format("woff2")}@font-face{font-display:swap;font-family:'Inter UI var alt';font-weight:100 900;font-style:italic;font-named-instance:'Italic';src:url(/fonts/Inter-italic.var.woff2) format("woff2")}.hero{min-height:600px;width:100%;background-position:top;background-size:cover;align-items:center;justify-content:center}html{scroll-padding-top:4rem;-webkit-text-size-adjust:100%}h1{line-height:3rem;font-size:3rem;margin:.67em 0}pre{max-width:calc(100%-3rem)}a{background-color:transparent;text-decoration:none;color:#444}strong{font-weight:700}button,code{font-size:1rem}img{display:block;border-style:none;max-width:100%;height:auto;margin:0 auto}button,html{line-height:1.15}button{font-family:inherit;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}details{display:block}h2{line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.5em}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){padding:1.5em;overflow-x:scroll}button,code{border-radius:.3em}code{color:#e2777a;padding:0 .3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%;background:#2d2d2d}h1,h2,html{font-family:Inter UI,sans-serif}a:hover,p a{text-decoration:underline}@media (min-width:600px){h1{font-size:4.3978rem;line-height:4.4rem;margin-bottom:1.496rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){body,p,pre,ul{font-size:1.2rem;line-height:1.6}p,pre,ul{margin-bottom:1.632rem}}@supports (font-variation-settings:normal){html{font-family:Inter UI var alt,sans-serif}}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;display:inline-block;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#fff;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body,header nav a{font-family:Inter UI,sans-serif;color:#444}body,header nav{background:#fff}header{text-align:center;max-width:100%;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav{position:fixed;top:0;left:0;width:100vw;padding:1rem;font-weight:200;text-align:right}header nav h1{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav a{font-weight:700;text-decoration:none;margin-left:1.5em}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}footer{background:#e9e9e9;padding:2rem;text-align:center}footer>*{margin:1.5em}footer nav a img{vertical-align:middle}footer nav,footer p{font-size:90%}article{max-width:50rem;padding:1rem;margin:0 auto}li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.punctuation{color:#ccc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.property{color:#f8c555}.token.important,.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.important{font-weight:700}.token.inserted{color:green}</style><header><nav><div id=nav><h1><a href=/ title=Homepage>dgls | blog</a></h1><a href=/about/ >About</a></div><div id=reading-progress aria-hidden=true></div></nav><div class=hero style="background-image: linear-gradient(rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.8)), url('/img/remote/dark_code.jpg')"><h1>Testing is important: three ways to easily improve test quality</h1><time datetime=2020-12-18>18 Dec 2020</time><aside>5 min read.</aside></div><dialog id=message></dialog></header><main><article><p>It’s no secret that testing is important. We rely on tests to describe intended behaviour, catch any subtle bugs and prevent regressions in our code. But why are tests always such a pain to write well? In mature codebases tests quickly become convoluted and, in my experience, testing is one of the most challenging aspects of software engineering.<p>This is because we don’t hold our tests – unit tests, integration tests, end-to-end tests or smoke-tests – to the same standards production code. Poor testing can make a codebase even more difficult to maintain than having no tests at all. Despite this, good testing practice flies under the radar and is easily neglected.<p>Let's challenge this and look at three qualities we expect of good production code, and apply this same thinking to test code – where such quality control is often absent.<h2>1) Don’t Repeat Yourself (DRY) 🔁</h2><p>People are obsessed with DRY when it comes to production code, often taking it <a href=https://dev.to/wuz/stop-trying-to-be-so-dry-instead-write-everything-twice-wet-5g33>too far</a>. This same anti-repeating is rarely applied to tests. Instead, testing becomes a haven for duplication, with information copied all-over the place. This is most prevalent in two forms.<ul><li><strong>Asserting</strong> – Often there are a tonne of very similar tests, copy pasted with minor tweaks. In reality, they often cover the same test case, with the rationale that it’s “making extra sure”.<li><strong>Setup</strong> – Some tests require laborious setup. Creating mock users, seeding test-data and making sure any dependencies are stubbed out. This setup often gets duplicated between tests or test-suites, with only minor tweaks.</ul><p>Duplicating assertions and setup both have the same knock-on impact. Bug-fixes, feature tweaks or refactoring quickly becomes a headache. Instead of being able to make a simple modification, a change becomes a game of whack-a-mole, wading through duplicated logic with seemingly unrelated tests starting to fail. You then notice some mocks are wrong, some tests don’t even work. We end up feeling like we need a sledgehammer rather than a scalpel.<p>Dave Cheney published a brilliant micro-blog on this very topic - you should definitely <a href=https://dave.cheney.net/2020/12/15/the-story-of-the-one-line-fix>check it out</a>. It summarises the mentality behind most duplication far better than I can.<h2>2) Scrutinize tests the same as any other code 🔍</h2><p>I recently <a href=https://dgls.dev/posts/avoid-utils/ >wrote a post on</a> one of the larger projects I’ve worked on during my career. This project, despite having some talented engineers working on it, was a complete mess. In particular, let's talk about code reviews and tests.<p>We all worked in the same physical office, so pull-requests were usually reviewed face-to-face.<p>This was great and worked really well – it was much easier to have open discussions, loop in people who should be involved, or to get answers to questions. I once overheard a discussion over a pull-request between two experienced developers. Their conversation bounced around discussing sensible topics – the high-level approach to solving a problem, justifying the design and making sure it was efficient. They then delved into the low-level, technical details – making suggestions for improving variables names, neatening up some abstractions, adhering to best practices and agreed standards.<p>Then it came to <s>reviewing</s> the tests.<p><em>"Yeah, it has tests"</em> said one engineer to the other. <em>"Do they pass?"</em>, the second questioned. <em>"Yes"</em>, replied the first. <em>"That's good"</em>, confirmed the second, as both engineers sat nodding to each other as they absent-mindedly scrolled through several hundred lines of tests.<p>Let's look at the real problem here: the measure of quality had nothing to do with the tests, beyond them simply existing and passing. There was no discussion around edge cases. Were they testing the right things? Was the generation of the test data suitable? Did they take the right approach to mocking? Did the tests even accurately describe what they're doing.<p>It came to no surprise to anyone, certainly myself, that the majority of tests on the project were useless. Needlessly so, too. By asking simple questions and caring enough to review the tests properly, they could have saved hours of work later down the line, for the sake of five minutes now.<h2>3) Avoid mocking integrations in integration tests 🔗</h2><p>It sounds obvious when it’s written out like that, right? But you’d be amazed how often this happens. Consider that we are writing a function responsible for adding new users to a mailing list for a product. A test for this might look like the following:<pre class=language-javascript><code class=language-javascript><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"mailing list list"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>emailStorage<span class="token punctuation">,</span> <span class="token string">"save"</span><span class="token punctuation">)</span><br>    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>emailStorage<span class="token punctuation">,</span> <span class="token string">"rollback"</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should add an email to a mailing list"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> email <span class="token operator">=</span> <span class="token function">mockEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> mailingList<span class="token punctuation">.</span><span class="token function">addEmail</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><br><br>    <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      email<span class="token operator">:</span> email<span class="token punctuation">,</span><br>      subscribed<span class="token operator">:</span> <span class="token boolean">true</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token function">expect</span><span class="token punctuation">(</span>emailStorage<span class="token punctuation">.</span>save<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>    <span class="token function">expect</span><span class="token punctuation">(</span>emailStorage<span class="token punctuation">.</span>rollback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toNotHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>This looks fairly typical, right? Although you could say that’s a lot of mocking for one test. It prompts the question:<p><em>“What are we actually testing here?”</em><p>Are we <em>unit</em> testing the logic the function contains? Or are we testing that it <em>integrates</em> properly with the email storage?<p>If it's a unit test, you’d argue to mock as much as you can so you are just testing the logic. We seem to be asserting on the mocks a lot though, which wouldn’t be the case if we weren’t also testing the integration.<p>In this case, how useful really is this test? It’s attempting to test an integration by integrating with a mock. This test looks a lot like it’s not really testing any behaviour at all - it’s just checking that the code does what the code does, at the same level of abstraction.<p>Say for example, that the email storage didn’t behave the way we expected it to. Would this test fail? Should this test fail? If we rewrote the test to use the real email storage, and then tested it worked in reality, would this be more valuable?<h2>Closing Remarks 💬</h2><p>Tests are just more code. More code that you should treat with the same level of respect as any other code. Write them well, and they can be a powerful asset that help you safely refactor and add new features. Write them poorly, and they will quickly become a burden. Every change you make becomes wading through mud, sledgehammer in hand. We must think carefully how to write our tests, and be as meticulous with testing as we are with the rest of our code. Unless we do this, tests are a nightmare.</p><script src=https://ko-fi.com/widgets/widget_2.js type=text/javascript></script><script type=text/javascript>kofiwidget2.init('Support Me on Ko-fi', '#444', 'R6R72KTY9');kofiwidget2.draw();</script><share-widget><button aria-label=Share href=https://dgls.dev/posts/testing-is-important/ on-click=share><div></div></button></share-widget><script type=application/ld+json>{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "Testing is important: three ways to easily improve test quality",
  "image": [],
  "author": "Douglas Parsons",
  "genre": "technology and programming",
  "publisher": {
    "@type": "Organization",
    "name": "Douglas Parsons",
    "logo": {
      "@type": "ImageObject",
      "url": "/img/favicon/favicon-192x192.png?hash=1eead310e9"
    }
  },
  "url": "https://dgls.dev/posts/testing-is-important/",
  "mainEntityOfPage": "https://dgls.dev/posts/testing-is-important/",
  "datePublished": "2020-12-18",
  "dateModified": "2021-08-10",
  "description": "It’s no secret that testing is important. We rely on tests to describe intended behaviour, catch any subtle bugs and prevent regressions in..."
}</script></article></main><footer><a href=/about/ >Douglas Parsons</a></footer>