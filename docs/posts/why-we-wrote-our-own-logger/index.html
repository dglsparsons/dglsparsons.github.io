<!DOCTYPE html><html domain=dgls.dev ga-id=UA-177820617-1 lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="/img/favicon/favicon.ico?hash=ba55cd0070" rel=icon><meta content=#f9c412 name=theme-color><title>Go Logger - Why we wrote our own</title><meta content="dgls | dev" property=og:site_name><meta content=https://dgls.dev property=og:url><meta content="Go Logger - Why we wrote our own" property=og:title><meta content=website property=og:type><meta content="Go Logger - Why we wrote our own" property=twitter:title><meta content="At Shamaazi, we found the existing Go libraries for logging overcomplicated and not neatly doing what we wanted. Instead, we wrote our own. Here's why." name=description><meta content="At Shamaazi, we found the existing Go libraries for logging overcomplicated and not neatly doing what we wanted. Instead, we wrote our own. Here's why." property=og:description><meta content="At Shamaazi, we found the existing Go libraries for logging overcomplicated and not neatly doing what we wanted. Instead, we wrote our own. Here's why." property=twitter:description><meta content=summary_large_image name=twitter:card><meta content=@dglsparsons name=twitter:site><meta content=@dglsparsons name=twitter:creator><meta content=https://dgls.dev/img/remote/logs.jpg property=twitter:image><meta content=https://dgls.dev/img/remote/Z1OoNkY.jpg property=og:image><link href=https://dgls.dev/posts/why-we-wrote-our-own-logger/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate title="dgls | blog" type=application/atom+xml><link href=/ rel=preconnect crossorigin=""><script src="/js/min.js?hash=17b5d2d281" async defer></script><script src="/js/cached.js?hash=4628d5e26f" async defer></script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary: #5DFDCB;--primary-dark: #02DE99}.hero,body{display:flex;flex-direction:column}body{min-height:100vh}body main{flex-grow:1}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px}share-widget div{width:30px;height:30px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center}.apple share-widget div{background-image:url(/img/share-apple.svg)}body,share-widget button{margin:0}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark)}aside{font-style:italic}#nav{z-index:2;position:relative}#reading-progress{z-index:1;background-color:var(--primary);width:100vw;position:absolute;left:0;top:0;bottom:0;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:100;src:url(/fonts/Inter-Thin.woff2) format("woff2"),url(/fonts/Inter-Thin.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:100;src:url(/fonts/Inter-ThinItalic.woff2) format("woff2"),url(/fonts/Inter-ThinItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:200;src:url(/fonts/Inter-ExtraLight.woff2) format("woff2"),url(/fonts/Inter-ExtraLight.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:200;src:url(/fonts/Inter-ExtraLightItalic.woff2) format("woff2"),url(/fonts/Inter-ExtraLightItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:300;src:url(/fonts/Inter-Light.woff2) format("woff2"),url(/fonts/Inter-Light.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:300;src:url(/fonts/Inter-LightItalic.woff2) format("woff2"),url(/fonts/Inter-LightItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:400;src:url(/fonts/Inter-Regular.woff2) format("woff2"),url(/fonts/Inter-Regular.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:400;src:url(/fonts/Inter-Italic.woff2) format("woff2"),url(/fonts/Inter-Italic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:500;src:url(/fonts/Inter-Medium.woff2) format("woff2"),url(/fonts/Inter-Medium.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:500;src:url(/fonts/Inter-MediumItalic.woff2) format("woff2"),url(/fonts/Inter-MediumItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:600;src:url(/fonts/Inter-SemiBold.woff2) format("woff2"),url(/fonts/Inter-SemiBold.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:600;src:url(/fonts/Inter-SemiBoldItalic.woff2) format("woff2"),url(/fonts/Inter-SemiBoldItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:700;src:url(/fonts/Inter-Bold.woff2) format("woff2"),url(/fonts/Inter-Bold.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:700;src:url(/fonts/Inter-BoldItalic.woff2) format("woff2"),url(/fonts/Inter-BoldItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:800;src:url(/fonts/Inter-ExtraBold.woff2) format("woff2"),url(/fonts/Inter-ExtraBold.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:800;src:url(/fonts/Inter-ExtraBoldItalic.woff2) format("woff2"),url(/fonts/Inter-ExtraBoldItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:normal;font-weight:900;src:url(/fonts/Inter-Black.woff2) format("woff2"),url(/fonts/Inter-Black.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI';font-style:italic;font-weight:900;src:url(/fonts/Inter-BlackItalic.woff2) format("woff2"),url(/fonts/Inter-BlackItalic.woff) format("woff")}@font-face{font-display:swap;font-family:'Inter UI var alt';font-weight:100 900;font-style:normal;font-named-instance:'Regular';src:url(/fonts/Inter-roman.var.woff2) format("woff2")}@font-face{font-display:swap;font-family:'Inter UI var alt';font-weight:100 900;font-style:italic;font-named-instance:'Italic';src:url(/fonts/Inter-italic.var.woff2) format("woff2")}.hero{min-height:600px;width:100%;background-position:top;background-size:cover;align-items:center;justify-content:center}html{scroll-padding-top:4rem;-webkit-text-size-adjust:100%}h1{line-height:3rem;font-size:3rem;margin:.67em 0}pre{max-width:calc(100%-3rem)}a{background-color:transparent;text-decoration:none;color:#444}b,strong{font-weight:700}button,code{font-size:1rem}small{font-size:80%;color:#ccc}img{display:block;border-style:none;max-width:100%;height:auto;margin:0 auto}button,html{line-height:1.15}button{font-family:inherit;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}h2{line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.5em}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){padding:1.5em;overflow-x:scroll}button,code{border-radius:.3em}code{color:#e2777a;padding:0 .3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%;background:#2d2d2d}h1,h2,html{font-family:Inter UI,sans-serif}a:hover,p a{text-decoration:underline}@media (min-width:600px){h1{font-size:4.3978rem;line-height:4.4rem;margin-bottom:1.496rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){body,p,pre,ul{font-size:1.2rem;line-height:1.6}p,pre,ul{margin-bottom:1.632rem}}@media (max-width:767px){x:-moz-any-link{display:table-cell}}@supports (font-variation-settings:normal){html{font-family:Inter UI var alt,sans-serif}}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;display:inline-block;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#fff;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body,header nav a{font-family:Inter UI,sans-serif;color:#444}body,header nav{background:#fff}header{text-align:center;max-width:100%;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav{position:fixed;top:0;left:0;width:100vw;padding:1rem;font-weight:200;text-align:right}header nav h1{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav a{font-weight:700;text-decoration:none;margin-left:1.5em}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}footer{background:#e9e9e9;padding:2rem;text-align:center}footer>*{margin:1.5em}footer nav a img{vertical-align:middle}footer nav,footer p{font-size:90%}article{max-width:50rem;padding:1rem;margin:0 auto}li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.punctuation{color:#ccc}.token.function,.token.number{color:#f08d49}.token.property{color:#f8c555}.token.important{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.important{font-weight:700}.token.inserted{color:green}</style><header><nav><div id=nav><h1><a href=/ title=Homepage>dgls | blog</a></h1><a href=/about/ >About</a></div><div id=reading-progress aria-hidden=true></div></nav><div class=hero style="background-image: linear-gradient(rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.8)), url('/img/remote/logs.jpg')"><h1>Go Logger - Why we wrote our own</h1><time datetime=2020-10-09>09 Oct 2020</time><aside>6 min read.</aside></div><dialog id=message></dialog></header><main><article><p>At Shaamazi, we created and open-sourced our logger: <a href=https://github.com/shamaazi/antilog>antilog</a>. We created this out of frustration at the other loggers available for Go. In our minds, they all fell short in at least one of several ways. We wanted a logger that was simple and easy to use. A logger that doesn't bring a mountain of dependencies. A logger that outputs structured logs. A logger where context can be built over time. And finally, a logger that doesn't have log-levels.<p>Here I'll look at the following:<ul><li>Why we care about logging so much.<li>What the current logging landscape for Go looks like.<li>Why each of these fundamental features (structured logging, building context and no log-levels) are so important<li>How popular alternatives fail to meet our needs.</ul><h2>Why we care about logging so much</h2><p>Our largest product is a charity system that automates donations during Ramadan. Over 160,000 people, in around 140 different countries, use this product. Despite this, our engineering team is tiny with two engineers working on this product. As a result, the ability to quickly and efficiently identify problems in our code through inspecting logs is crucial.<h2>What other logs are there?</h2><p>Go's standard library provides a <a href=https://golang.org/pkg/log/ >logger module</a>. Yet, this module is very minimal: it gives a series of functions that can be called to log text, but little else. There are some 'batteries included' logging frameworks, such as <a href=https://github.com/sirupsen/logrus>logrus</a>. Unfortunately, we wanted a middle ground between the two. Logrus provided too much customisability. It is very verbose to use, and has a significant footprint. However, the standard library wasn't able to provide all the features we wanted. A third alternative is the <a href=https://github.com/uber-go/zap>zap</a> logger created by Uber. This looks like a strong contender but adds a lot of complexity. It has far more configuration with its various logger types (Sugar, Production, Development, etc.). There is also a <code>Sync()</code> function, a mix of <code>sprintf</code> and structured logging, and log-levels.<p>Other alternatives do exist, but we could not find one that met our criteria.<h2>Structured Logging</h2><p>Structured logging is the idea that logs should be more than a string message. They should also be able to embed and display structured information. There are two approaches to this: using a human-readable <a href=https://brandur.org/logfmt>logfmt</a> format, or, writing logs out as JSON. Logfmt has it's advantages; it is arguably more human-readable at an initial glance. However, most tools for searching through logs, such as Splunk, Kibana or CloudWatch, provide support for JSON logs. JSON is easier for programs to read and query and also allows complex datatypes to be expressed in logs. In our case, we are writing logs into CloudWatch. CloudWatch provides explicit support for querying JSON logs. As a result, we are <strong>only</strong> interested in writing JSON.<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/cloudwatch-logs-1920w.webp 1920w, /img/cloudwatch-logs-1280w.webp 1280w, /img/cloudwatch-logs-640w.webp 640w, /img/cloudwatch-logs-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/cloudwatch-logs-1920w.jpg 1920w, /img/cloudwatch-logs-1280w.jpg 1280w, /img/cloudwatch-logs-640w.jpg 640w, /img/cloudwatch-logs-320w.jpg 320w" type=image/jpeg><img alt="What our (test) logs look like in cloudwatch" decoding=async height=768 loading=lazy src=/img/cloudwatch-logs.jpg style="background-size:cover;contain-intrinsic-size: min(var(--main-width), 1620px) min(calc(var(--main-width) * 0.4740740740740741), 768px);background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1620 768'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' x='0' y='0' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAIAAAAcxIEBAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAYElEQVQI112K2w4DIQhE/f9vbbuKGxeGi0VjX3pyAmSY0loj6letr/enbogoo6RTz29hkUeGGszNl255/VDVkmvIGLjV4WExYx5iO1cDCrbHQuOkEdvTYGaBpIDoH1jjCw6doOru4FkiAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)" width=1620></picture><p>The ideal would be for any logger to output JSON by default. Some loggers, such as zap, meet this need. Of the main two most popular contenders, the standard library and logrus, both fall short. The standard library doesn't provide structured logging at all. Logrus does but requires some small amount of config to achieve this (<code>logrus.SetFormatter(&logrus.JSONFormatter{})</code>). This configuration is only a single line of code, but it is easy to miss when writing a new application, script or tool.<p>Supporting many output formats is another pitfall. This adds more complexity to the logger, making it bulkier than we would like (in both binary size and CPU time). Instead, a logger that outputs JSON by default with no configuration required is ideal. antilog can be used straight out of the box, it requires no configuration at all.<h2>Building Context</h2><p>As part of our logging, we want the ability to build up of information in logs over the lifecycle of an operation. To get a full picture of what is happening in our logs, we need to be able to provide context to any messages. To illustrate this point, here is a pretty rubbish log message that could show an issue parsing data:<pre class=language-json><code class=language-json><span class="token punctuation">{</span> <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2019-11-18T14:00:32Z"</span><span class="token punctuation">,</span> <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"unable to parse json"</span> <span class="token punctuation">}</span></code></pre><p>We can't easily identify what is going on here: is this an application issue? is it expected? What's causing it? By adding a small amount of context we can immediately glean much more information from our logs:<pre class=language-json><code class=language-json><span class="token punctuation">{</span> <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2019-11-18T14:00:32Z"</span><span class="token punctuation">,</span> <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"unable to parse json"</span><span class="token punctuation">,</span> <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/api/signup"</span><span class="token punctuation">,</span> <span class="token property">"method"</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token property">"status"</span><span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token property">"request_id"</span><span class="token operator">:</span> <span class="token string">"1234abc"</span><span class="token punctuation">}</span></code></pre><p>We can now see that it's an API endpoint for signup this happened at. From the 400 response, we can assume that this is due to a user submitting bad data rather than an error in our system. From a small amount of context, a previously meaningless log message becomes valuable.<p>Unless we have a messy codebase, the places where want to write logs don't necessarily have access to all the information we might want. We don't want polluting to our code by passing <code>path</code>, <code>method</code>, <code>request_id</code> and many other fields around. We want the ability to attach these to our logger, building up the eventual output one piece at a time.<p>In antilog we can build up an output by passing the logger around (or attaching it to context, if you've done much Go):<pre class=language-go><code class=language-go>    logger <span class="token operator">:=</span> antilog<span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span><br>       <span class="token string">"common"</span><span class="token punctuation">,</span> <span class="token string">"this is a common field"</span><span class="token punctuation">,</span><br>       <span class="token string">"other"</span><span class="token punctuation">,</span> <span class="token string">"I also should be logged always"</span><span class="token punctuation">)</span><br><br>    logger<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"I'll be logged with common and other field"</span><span class="token punctuation">)</span><br>    logger<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"Me too"</span><span class="token punctuation">)</span></code></pre><h2>No Log levels</h2><p>A lack of log-levels seems like an oversight for a logging library. However, I strongly believe they aren't necessary and just complicate matters. Dave Cheney argues the same on <a href=https://dave.cheney.net/2015/11/05/lets-talk-about-logging>his blog</a>. This can be broken down by reasoning about each different log level:<p><strong>Warning:</strong><p>Warning messages fall into one of two categories:<ul><li>warnings you can ignore<li>warnings you can't ignore</ul><p>Warnings that you can ignore are interesting. By definition, nothing has gone wrong. As such, they are no different to info level logs. Warnings that you can't ignore show the opposite: they are errors that are not logged at the correct level. As it is impossible to have a warning that does not fit into these two categories, warning as a log level is useless.<p><strong>Error:</strong><p>A similar approach removes the need for errors. Errors fall into one of two categories:<ul><li>Errors that you are handling (and recovering from)<li>Errors that you are not handling.</ul><p>If you are handling the error, then the application will continue as expected, and the log line is only informational. If you are not handling the error, then you should not be logging it. It is the responsibility of the calling code to manage this error. As it is impossible to have an error that does not fit into these categories, the error log level is also useless.<p><strong>Info:</strong><p>Now there are no more warnings and errors, we have a single log-level: info. By itself, this is no different to not having any log levels at all. Instead, we have 'things we should log' and 'things we shouldn't log'.<p>This argument to remove log levels can extend further. Log-levels are an attempt to provide a measure of how useful a particular message is. This is a flawed approach as the usefulness can't be determined when the message is written. This is because we do not know why our future selves may be looking at logs. It could be to diagnose a particular race condition, to fix a bug, or to track user behaviour. Without knowing why we will be looking at logs, it is impossible to determine what information is going to be the most relevant. Any attempt to predict is just noise. As a result, log-levels are a fruitless task.<p>In the context of antilog, we wanted to avoid the typical <code>log.Info</code>, <code>log.Warn</code> and <code>log.Error</code> interfaces most loggers use. This leads to forced decision-making that is not productive. I've been on the end of one-too-many arguments over whether a log should be <code>Info</code> or <code>Warn</code> (see also <a href=https://en.wiktionary.org/wiki/bikeshedding>bikeshedding</a>). Most logging libraries do not give this freedom of thinking, and instead, force you to decide. We, contrastingly, provide just a <code>Write</code> method. Either <code>Write</code> your logs or don't.<h2>In Conclusion</h2><p>The current logging landscape for Go was lacking. Existing libraries overcomplicated the process of writing logs by falling into one of four traps:<ul><li>forcing the use of log-levels;<li>lacking structured logging;<li>not allowing context to be built<li>and allowing too much configuration.</ul><p>We sought a solution to these problems by creating our logging library, <a href=https://github.com/shamaazi/antilog>antilog</a>. We've been using it for around a year now and love it.</p><script src=https://ko-fi.com/widgets/widget_2.js type=text/javascript></script><script type=text/javascript>kofiwidget2.init('Support Me on Ko-fi', '#444', 'R6R72KTY9');kofiwidget2.draw();</script><share-widget><button aria-label=Share href=https://dgls.dev/posts/why-we-wrote-our-own-logger/ on-click=share><div></div></button></share-widget><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Go Logger - Why we wrote our own","image":["https://dgls.dev/img/cloudwatch-logs.jpg"],"author":"Douglas Parsons","genre":"technology and programming","publisher":{"@type":"Organization","name":"Douglas Parsons","logo":{"@type":"ImageObject","url":"/img/favicon/favicon-192x192.png?hash=1eead310e9"}},"url":"https://dgls.dev/posts/why-we-wrote-our-own-logger/","mainEntityOfPage":"https://dgls.dev/posts/why-we-wrote-our-own-logger/","datePublished":"2020-10-09","dateModified":"2021-08-10","description":"At Shaamazi, we created and open-sourced our logger: antilog. We created this out of frustration at the other loggers available for Go. In..."}</script></article></main><footer><a href=/about/ >Douglas Parsons</a></footer>